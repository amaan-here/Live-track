<!DOCTYPE html>
<html lang="en">
<head>
    <title>Udaipur Bus Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root{--surface-color:#ffffff; --text-color:#1a202c; --accent-color:#3182ce; --shadow-color: rgba(0,0,0,0.1);}
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }
        #map-container { position: absolute; top: 20px; right: 20px; bottom: 20px; left: 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px var(--shadow-color); }
        #map { width: 100%; height: 100%; }
        
        /* Modified Search Container */
        #search-container { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; z-index: 1000; }
        .search-box { display: flex; box-shadow: 0 5px 15px var(--shadow-color); }
        #search-input { flex-grow: 1; padding: 15px 20px; font-size: 1.1rem; border: 1px solid #ddd; background-color: var(--surface-color); color: var(--text-color); border-radius: 12px 0 0 12px; }
        #search-btn { padding: 0 20px; font-size: 1.2rem; border: 1px solid #ddd; border-left: none; background-color: var(--accent-color); color: white; cursor: pointer; border-radius: 0 12px 12px 0; }
        
        #suggestions-list { list-style: none; padding: 0; margin: 10px 0 0 0; background-color: var(--surface-color); border-radius: 12px; max-height: 250px; overflow-y: auto; box-shadow: 0 5px 15px var(--shadow-color); }
        #suggestions-list li { padding: 12px 20px; color: var(--text-color); cursor: pointer; border-bottom: 1px solid #eee; }
        #suggestions-list li:hover { background-color: #f0f2f5; }
        #suggestions-list li:last-child { border-bottom: none; }
        #stops-dropdown-container { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; z-index: 999; }
        #stops-dropdown { width: 100%; padding: 15px; font-size: 1rem; border-radius: 12px; border: 1px solid #ddd; background-color: var(--surface-color); color: var(--text-color); box-shadow: 0 5px 15px var(--shadow-color); }
        #relocate-btn { position: absolute; bottom: 30px; right: 20px; z-index: 1000; background-color: var(--surface-color); color: var(--text-color); border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 2px 8px var(--shadow-color); display: flex; align-items: center; justify-content: center; }
        .bus-icon { background: transparent; border: none; font-size: 24px; text-align: center; line-height: 24px; }
    </style>
</head>
<body>

    <div id="map-container">
        <div id="map"></div>
        <button id="relocate-btn" title="Recenter on my location">üìç</button>
    </div>

    <div id="search-container">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Search Destination or Live Bus...">
            <button id="search-btn">üîç</button>
        </div>
        <ul id="suggestions-list"></ul>
    </div>

    <div id="stops-dropdown-container" style="display: none;">
        <select id="stops-dropdown">
            <option>Select a nearby bus stop</option>
        </select>
    </div>

    <script>
        // --- DATA AND GLOBAL VARIABLES ---
        const locationsDB = [
            { name: "City Palace", type: "destination", lat: 24.5763, lng: 73.6841 }, { name: "Lake Pichola", type: "destination", lat: 24.5725, lng: 73.6785 }, { name: "Saheliyon Ki Bari", type: "destination", lat: 24.6096, lng: 73.6882 }, { name: "Fateh Sagar Lake", type: "destination", lat: 24.6022, lng: 73.6763 }, { name: "Ghantaghar Stop", type: "bus_stop", lat: 24.5799, lng: 73.6845 }, { name: "Doodh Talai Stop", type: "bus_stop", lat: 24.5685, lng: 73.6821 }, { name: "Chetak Circle", type: "bus_stop", lat: 24.5880, lng: 73.6930 }, { name: "Railway Station", type: "bus_stop", lat: 24.5721, lng: 73.7032 }, { name: "Fatehpura Stop", type: "bus_stop", lat: 24.5983, lng: 73.6826 }
        ];
        const liveBusMarkers = {};
        let userMarker = null, destinationMarker = null, routePolyline = null;
        
        // UI Elements
        const map = L.map('map').setView([24.5854, 73.7125], 14);
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn'); // New button
        const suggestionsList = document.getElementById('suggestions-list');
        const stopsDropdownContainer = document.getElementById('stops-dropdown-container');
        const stopsDropdown = document.getElementById('stops-dropdown');
        const relocateBtn = document.getElementById('relocate-btn');

        function initApp() {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            startUserTracking();
            setupEventListeners();
            connectToSocketServer();
        }

        function setupEventListeners() {
            searchInput.addEventListener('input', () => showSuggestions(searchInput.value));
            
            searchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    // Re-use the same search logic for the button click
                    confirmSearch();
                }
            });

            // Add click listener for the new search button
            searchBtn.addEventListener('click', confirmSearch);

            stopsDropdown.addEventListener('change', () => {
                if (!userMarker) return alert("Your location is not available yet.");
                const selectedStop = JSON.parse(stopsDropdown.value);
                const stopLatLng = L.latLng(selectedStop.lat, selectedStop.lng);
                if (destinationMarker) map.removeLayer(destinationMarker);
                destinationMarker = L.marker(stopLatLng).addTo(map);
                drawRoute(userMarker.getLatLng(), stopLatLng, `<b>${selectedStop.name}</b>`);
                stopsDropdownContainer.style.display = 'none';
            });

            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target)) {
                    suggestionsList.innerHTML = '';
                }
            });

            relocateBtn.addEventListener('click', () => {
                if (userMarker) {
                    map.flyTo(userMarker.getLatLng(), 16);
                } else {
                    alert("Your location is not being tracked yet. Please enable location tracking first.");
                }
            });
        }
        
        // --- New function to handle both Enter key and button click ---
        function confirmSearch() {
            const firstSuggestion = suggestionsList.firstChild;
            if (firstSuggestion) {
                firstSuggestion.click();
            }
        }
        
        // --- All other functions (connectToSocketServer, updateLiveBusMarker, etc.) remain the same ---
        function connectToSocketServer(){const t=io();t.on("connect",()=>console.log("Connected to real-time server!")),t.on("new_location",t=>{console.log("Received live data:",t),updateLiveBusMarker(t.device_id,[t.location.lat,t.location.lng])})}
        function updateLiveBusMarker(t,e){const o=t.toLowerCase();liveBusMarkers[o]?liveBusMarkers[o].setLatLng(e):(liveBusMarkers[o]=L.marker(e,{icon:L.divIcon({className:"bus-icon",html:"üöå",iconSize:[24,24]})}).addTo(map).bindPopup(`<b>Live Bus:</b> ${t}`))}
        function startUserTracking(){if(!navigator.geolocation)return alert("Geolocation is not supported.");navigator.geolocation.watchPosition(t=>{const e=[t.coords.latitude,t.coords.longitude];userMarker?userMarker.setLatLng(e):(userMarker=L.circleMarker(e,{radius:8,color:"#3182ce",fillColor:"#3182ce",fillOpacity:1}).addTo(map).bindPopup("<b>Your Location</b>").openPopup(),map.panTo(e)),routePolyline&&drawRoute(userMarker.getLatLng(),routePolyline.getLatLngs()[1],destinationMarker.getPopup().getContent())})}
        function showSuggestions(t){suggestionsList.innerHTML="";const e=t.toLowerCase();if(!e)return;const o=Object.keys(liveBusMarkers).filter(t=>t.includes(e)),n=locationsDB.filter(t=>t.name.toLowerCase().includes(e));[...n,...o].forEach(t=>{const e=document.createElement("li");"string"==typeof t?(e.textContent=`Live Bus: ${t}`,e.onclick=()=>handleSuggestionClick({name:t,type:"live_bus"})):(e.textContent=t.name,e.onclick=()=>handleSuggestionClick(t)),suggestionsList.appendChild(e)})}
        function handleSuggestionClick(t){const e=t.name.toLowerCase();searchInput.value=t.name,suggestionsList.innerHTML="",destinationMarker&&map.removeLayer(destinationMarker),"live_bus"===t.type?liveBusMarkers[e]&&(map.flyTo(liveBusMarkers[e].getLatLng(),16),liveBusMarkers[e].openPopup(),stopsDropdownContainer.style.display="none"):(destinationMarker=L.marker([t.lat,t.lng]).addTo(map).bindPopup(`<b>${t.name}</b>`).openPopup(),map.flyTo([t.lat,t.lng],15),findNearbyStops(t))}
        function findNearbyStops(t){const e=L.latLng(t.lat,t.lng),o=locationsDB.filter(t=>"bus_stop"===t.type).map(t=>(t.distance=e.distanceTo(L.latLng(t.lat,t.lng)),t)).sort((t,e)=>t.distance-e.distance).slice(0,3);populateStopsDropdown(o)}
        function populateStopsDropdown(t){stopsDropdown.innerHTML='<option selected disabled>Select a nearby bus stop...</option>',t.forEach(t=>{const e=document.createElement("option");e.value=JSON.stringify(t),e.textContent=`${t.name} (${Math.round(t.distance)}m away)`,stopsDropdown.appendChild(e)}),stopsDropdownContainer.style.display="block"}
        function drawRoute(t,e,o){routePolyline&&map.removeLayer(routePolyline);const n=t.distanceTo(e),i=Math.round(n/1.4/60);destinationMarker&&destinationMarker.bindPopup(`${o}<hr><b>~ ${i} min walk</b>`).openPopup(),routePolyline=L.polyline([t,e],{color:"#e53e3e",weight:4}).addTo(map),map.fitBounds([t,e],{padding:[50,50]})}
        
        initApp();
    </script>
</body>
</html>