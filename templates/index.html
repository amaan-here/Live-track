<!DOCTYPE html>
<html lang="en">
<head>
    <title>Udaipur Bus Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://unpkg.com/@googlemaps/polyline-codec@1.0.28/dist/polyline-codec.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root{--surface-color:#ffffff; --text-color:#1a202c; --accent-color:#3182ce; --shadow-color: rgba(0,0,0,0.1);}
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }
        #map-container { position: absolute; top: 20px; right: 20px; bottom: 20px; left: 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px var(--shadow-color); }
        #map { width: 100%; height: 100%; background-color: #e0e0e0; }
        #search-container { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; z-index: 10; }
        .search-box { display: flex; box-shadow: 0 5px 15px var(--shadow-color); }
        #search-input { flex-grow: 1; padding: 15px 20px; font-size: 1.1rem; border: 1px solid #ddd; background-color: var(--surface-color); color: var(--text-color); border-radius: 12px 0 0 12px; }
        #search-btn { padding: 0 20px; font-size: 1.2rem; border: 1px solid #ddd; border-left: none; background-color: var(--accent-color); color: white; cursor: pointer; border-radius: 0 12px 12px 0; }
        #stops-dropdown-container { position: absolute; top: 110px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; z-index: 9; }
        #stops-dropdown { width: 100%; padding: 15px; font-size: 1rem; border-radius: 12px; border: 1px solid #ddd; background-color: var(--surface-color); color: var(--text-color); box-shadow: 0 5px 15px var(--shadow-color); }
    </style>
</head>
<body>

    <div id="map-container">
        <div id="map"></div>
    </div>

    <div id="search-container">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Search Destination...">
            <button id="search-btn">üîç</button>
        </div>
    </div>

    <div id="stops-dropdown-container" style="display: none;">
        <select id="stops-dropdown">
            <option>Select a nearby bus stop</option>
        </select>
    </div>

    <script>
        let map;
        const liveBusMarkers = {};
        let userMarker = null, destinationMarker = null, routePolyline = null;
        let infoWindow;

        // UI Elements
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const stopsDropdownContainer = document.getElementById('stops-dropdown-container');
        const stopsDropdown = document.getElementById('stops-dropdown');

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 24.5854, lng: 73.7125 },
                zoom: 14,
                mapTypeControl: false,
                streetViewControl: false
            });

            infoWindow = new google.maps.InfoWindow();
            
            startUserTracking();
            setupEventListeners();
            connectToSocketServer();
        }

        function connectToSocketServer() {
            const socket = io();
            socket.on('connect', () => console.log('Connected to real-time server!'));
            socket.on('new_location', (data) => {
                updateLiveBusMarker(data.device_id, { lat: data.location.lat, lng: data.location.lng });
            });
        }

        function updateLiveBusMarker(deviceId, latLng) {
            const deviceIdKey = deviceId.toLowerCase();
            if (liveBusMarkers[deviceIdKey]) {
                liveBusMarkers[deviceIdKey].setPosition(latLng);
            } else {
                liveBusMarkers[deviceIdKey] = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    title: `Live Bus: ${deviceId}`,
                    icon: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#1a202c"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2V9c0-.55-.45-1-1-1zm-6 10H6c-.55 0-1-.45-1-1V6h11v12zM7 15c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm10 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>')
                });
            }
        }

        function startUserTracking() {
            if (!navigator.geolocation) return alert("Geolocation is not supported.");
            navigator.geolocation.watchPosition(position => {
                const latLng = { lat: position.coords.latitude, lng: position.coords.longitude };
                if (!userMarker) {
                    userMarker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        title: "Your Location",
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: '#3182ce', fillOpacity: 1, strokeWeight: 2, strokeColor: '#ffffff' }
                    });
                    map.panTo(latLng);
                } else {
                    userMarker.setPosition(latLng);
                }
            });
        }

        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query || !userMarker) {
                return alert("Please enter a destination and enable your location.");
            }
            const userLatLng = userMarker.getPosition().toJSON();

            try {
                const response = await fetch(`/search_destination?query=${encodeURIComponent(query)}&lat=${userLatLng.lat}&lng=${userLatLng.lng}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                if (destinationMarker) destinationMarker.setMap(null);
                
                const destLoc = data.destination.location;
                destinationMarker = new google.maps.Marker({ position: destLoc, map: map, title: data.destination.name });
                map.panTo(destLoc);
                populateStopsDropdown(data.nearby_stops);

            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function populateStopsDropdown(stops) {
            stopsDropdown.innerHTML = '<option selected disabled>Select a nearby bus stop...</option>';
            if (stops.length === 0) {
                stopsDropdown.innerHTML = '<option disabled>No nearby stops found.</option>';
            }
            stops.forEach(stop => {
                const option = document.createElement('option');
                option.value = JSON.stringify(stop.location);
                option.textContent = stop.name;
                stopsDropdown.appendChild(option);
            });
            stopsDropdownContainer.style.display = 'block';
        }

        async function drawRoute(startLatLng, endLatLng, stopName) {
            if (routePolyline) routePolyline.setMap(null);
            
            const start = `${startLatLng.lat},${startLatLng.lng}`;
            const end = `${endLatLng.lat},${endLatLng.lng}`;
            
            try {
                const response = await fetch(`/get_route?start=${start}&end=${end}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                const routePath = google.maps.geometry.encoding.decodePath(data.polyline);
                routePolyline = new google.maps.Polyline({
                    path: routePath,
                    geodesic: true,
                    strokeColor: '#3182ce',
                    strokeOpacity: 0.8,
                    strokeWeight: 5
                });
                routePolyline.setMap(map);
                
                const bounds = new google.maps.LatLngBounds();
                routePath.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);

                infoWindow.setContent(`<b>${stopName}</b><br>~ ${data.duration} walk`);
                infoWindow.open(map, destinationMarker);
                
            } catch (error) {
                console.error("Routing Error:", error);
            }
        }

        function setupEventListeners() {
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleSearch();
            });

            stopsDropdown.addEventListener('change', () => {
                if (!userMarker) return alert("Your location is not available yet.");
                const selectedStopLocation = JSON.parse(stopsDropdown.value);
                const stopLatLng = { lat: selectedStopLocation.lat, lng: selectedStopLocation.lng };
                const stopName = stopsDropdown.options[stopsDropdown.selectedIndex].text;

                if (destinationMarker) destinationMarker.setMap(null);
                destinationMarker = new google.maps.Marker({ position: stopLatLng, map: map });
                
                drawRoute(userMarker.getPosition().toJSON(), stopLatLng, stopName);
            });
        }
    </script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5wNRRJqibs9qG7nX6Xgt2z38-UcNr-wI&callback=initMap&libraries=geometry,places"></script>
</body>
</html>